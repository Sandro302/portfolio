# ТЗ для BackEnd

**Обновлено:** 8 октября 2025, 11:04

## Документация Backend-модуля

### Содержание

1. [Термины и определения](#термины-и-определения)
2. [Диаграмма](#диаграмма)
3. [Требования к реализации](#требования-к-реализации)
4. [Логика работы](#логика-работы)

## Термины и определения

| Термин | Описание |
|--------|----------|
| OLGA-проект | Инженерный файл в формате `.opi`, `.tpl`, `.tab` |
| API | Точка доступа REST-интерфейса |
| Расчет | Запуск ядра с заданными параметрами |
| Обработчик | Блок backend-логики, отвечающий за отдельную функцию |
| Парсер | Модуль, разбирающий XML/текстовые входные файлы в структуру |

## Диаграмма

Основная диаграмма взаимодействия компонентов:

```mermaid
@startuml
scale 1.5
skinparam defaultFontSize 16
skinparam sequenceParticipantFontSize 14
skinparam sequenceMessageFontSize 14
skinparam sequenceGroupFontSize 13

actor Пользователь
participant Frontend
participant Backend
database БазаДанных
autonumber

== Импорт проекта ==

Пользователь -> Frontend : Загружает файлы .opi/.tpl/.tab
activate Frontend
Frontend -> Backend : POST /projects/import (multipart)
activate Backend
Backend -> Backend : Валидация структуры
Backend -> БазаДанных : Сохранение информации о проекте
activate БазаДанных
БазаДанных --> Backend : OK
deactivate БазаДанных
Backend --> Frontend : 201 Created + projectId
deactivate Backend
Frontend --> Пользователь : Уведомление об успешном импорте
deactivate Frontend
@enduml
```

### Импорт проекта

- Пользователь загружает файлы `.opi/.tpl/.tab`
- Frontend формирует multipart/form-data запрос
- Backend принимает файлы, валидирует структуру
- Backend сохраняет данные проекта в базу данных
- Backend возвращает 201 Created и projectId
- Frontend отображает уведомление об успешном импорте

### Запуск расчёта (асинхронный)

- Пользователь нажимает кнопку "Запустить расчёт"
- Frontend отправляет POST /projects/{id}/run
- Backend отправляет задачу в очередь (Kafka)
- Модуль расчёта потребляет задачу из очереди
- Выполняется расчёт с итерациями
- Результаты сохраняются в БД
- Уведомление отправляется через Kafka обратно в Frontend
- Frontend получает событие calculationFinished через WebSocket
- Пользователь может просмотреть результаты

## Требования к реализации

### Функциональные требования

- **Загрузка файлов**: Поддержка загрузки файлов `.opi`, `.tpl`, `.tab` через API
- **Валидация**: Разбор и валидация структуры проекта
- **Хранение**: Хранение проекта в БД (структура, параметры, связи)
- **API методы**:
  - GET /projects - получение списка проектов
  - POST /projects/import - импорт проекта
  - POST /projects/{id}/run - запуск расчёта
  - GET /projects/{id}/results - получение результатов
  - GET /projects/{id}/status - получение статуса

### Нефункциональные требования

- **Производительность**:
  - Время отклика API: ≤ 500 мс (без расчёта)
  - Асинхронная обработка расчётов
  - Кэширование результатов

- **Надёжность**:
  - Обработка ошибок с возвратом корректных кодов HTTP
  - Валидация входных данных
  - Логирование всех операций

- **Масштабируемость**:
  - Хранение данных — PostgreSQL
  - Очереди задач — Kafka
  - Горизонтальное масштабирование через микросервисы

- **Безопасность**:
  - Аутентификация и авторизация пользователей
  - Ограничение размера загружаемых файлов (max 50 МБ)
  - Проверка типов файлов

## Логика работы

### Импорт проекта

**Endpoint:** `POST /projects/import`

**Параметры:**
- multipart/form-data с файлами `.opi`, `.tpl`, `.tab`

**Процесс:**

1. Получение запроса на `/projects/import`
2. Валидация пользователя (аутентификация)
3. Проверка размера файлов (max 50 МБ)
4. Сохранение файлов во временную директорию
5. Проверка расширений файлов
6. Парсинг `.opi` → структура проекта
7. Если найден `.tpl`, парсинг труб/источников
8. Если найден `.tab`, связывание состава флюида
9. Валидация структуры (проверка связей, параметров)
10. Сохранение структуры в БД (таблицы projects, elements, connections)
11. Сохранение метаданных (дата создания, пользователь)
12. Удаление временных файлов
13. Ответ 201 Created с projectId и основной информацией

**Ошибки:**
- 400 Bad Request - неверный формат файла
- 413 Payload Too Large - файл слишком большой
- 415 Unsupported Media Type - неподдерживаемый тип файла
- 500 Internal Server Error - ошибка парсинга

### Запуск расчёта

**Endpoint:** `POST /projects/{id}/run`

**Параметры:**
- projectId (path parameter)
- calculationParams (body, optional) - переопределение параметров

**Процесс:**

1. Получение запроса на `/projects/{id}/run`
2. Валидация projectId
3. Получение структуры проекта из БД
4. Проверка корректности (все параметры заполнены)
5. Создание record расчёта в БД (status: QUEUED)
6. Формирование сообщения для очереди Kafka
7. Отправка сообщения в очередь `calculations`
8. Ответ 202 Accepted с calculationId
9. Модуль расчёта потребляет сообщение из очереди
10. Инициализация расчётного ядра с параметрами
11. Выполнение итераций (обновление status: IN_PROGRESS)
12. Сохранение промежуточных результатов (каждые N итераций)
13. Завершение расчёта (status: COMPLETED)
14. Сохранение финальных результатов в БД
15. Отправка события calculationFinished в Kafka
16. Frontend получает событие через WebSocket и уведомляет пользователя

**Ошибки:**
- 404 Not Found - проект не найден
- 400 Bad Request - некорректные параметры расчёта
- 409 Conflict - расчёт уже запущен

### Получение результатов

**Endpoint:** `GET /projects/{id}/results`

**Параметры:**
- projectId (path parameter)
- calculationId (query parameter, optional)

**Процесс:**

1. Получение запроса на `/projects/{id}/results`
2. Валидация projectId
3. Получение расчёта из БД
4. Если calculationId не указан - получить последний расчёт
5. Проверка статуса расчёта (должен быть COMPLETED)
6. Получение результатов из БД
7. Форматирование результатов (JSON)
8. Ответ 200 OK с результатами

**Структура результатов:**
```json
{
  "calculationId": "uuid",
  "status": "COMPLETED",
  "startTime": "ISO8601",
  "endTime": "ISO8601",
  "results": {
    "elements": [{"id": "...", "name": "...", "values": {...}}],
    "summary": {...}
  }
}
```

## Стек технологий

- **Язык**: Python/Node.js
- **Framework**: FastAPI / Express
- **БД**: PostgreSQL
- **Очередь**: Apache Kafka
- **Кэш**: Redis (optional)
- **Логирование**: ELK Stack / Datadog
- **Мониторинг**: Prometheus + Grafana

---

**Источник:** Яндекс Вики - ТЗ для BackEnd
**Дата:** 8 октября 2025
