openapi: 3.0.3
info:
  title: Engineering Pipeline Calculation System API
  version: 1.0.0
  description: >
    REST API для системы расчёта и визуализации параметров трубопровода.
    Поддерживает операции с проектами, импорт из OLGA, запуск расчётов и получение результатов.
  contact:
    name: API Support
    email: support@example.com

servers:
  - url: https://api.example.com/v1
    description: Production server (example)
  - url: https://sandbox.api.example.com/v1
    description: Sandbox server (example)

tags:
  - name: Projects
    description: Управление проектами и их метаданными
  - name: Import
    description: Импорт проектов из внешних систем (OLGA)
  - name: Calculations
    description: Запуск и управление расчётами
  - name: Results
    description: Получение и экспорт результатов
  - name: Notifications
    description: Подписка на обновления и события

paths:
  /projects:
    get:
      tags:
        - Projects
      summary: Список проектов
      description: Возвращает список проектов с базовой информацией и статусами последних расчётов.
      operationId: listProjects
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
          description: Максимальное количество элементов в ответе.
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
          description: Смещение для постраничной навигации.
        - in: query
          name: search
          schema:
            type: string
          description: Фильтр по имени проекта (подстрока).
      responses:
        '200':
          description: Успешно получен список проектов.
          content:
            application/json:
              schema:
                type: object
                properties:
                  total:
                    type: integer
                    description: Общее количество проектов.
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/ProjectSummary'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      tags:
        - Projects
      summary: Создание нового проекта
      description: Создаёт новый пустой проект без данных OLGA.
      operationId: createProject
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateProjectRequest'
      responses:
        '201':
          description: Проект успешно создан.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectDetails'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
        '500':
          $ref: '#/components/responses/InternalError'

  /projects/{projectId}:
    get:
      tags:
        - Projects
      summary: Получение информации о проекте
      operationId: getProject
      parameters:
        - $ref: '#/components/parameters/ProjectId'
      responses:
        '200':
          description: Информация о проекте.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProjectDetails'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

    delete:
      tags:
        - Projects
      summary: Удаление проекта
      operationId: deleteProject
      parameters:
        - $ref: '#/components/parameters/ProjectId'
      responses:
        '204':
          description: Проект успешно удалён.
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Невозможно удалить проект, есть активные расчёты.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalError'

  /projects/import/olga:
    post:
      tags:
        - Import
      summary: Импорт проекта из OLGA
      description: >
        Принимает один или несколько файлов OLGA, валидирует их и создаёт проект
        с импортированными сущностями (узлы, трубы, профили).
      operationId: importOLGA
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - files
              properties:
                name:
                  type: string
                  description: Человекочитаемое имя проекта.
                description:
                  type: string
                  description: Описание проекта.
                files:
                  type: array
                  items:
                    type: string
                    format: binary
                  description: Файлы проекта OLGA.
      responses:
        '201':
          description: Проект успешно импортирован.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImportOLGAResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '422':
          description: Ошибка валидации структуры файлов OLGA.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalError'

  /projects/{projectId}/calculations:
    post:
      tags:
        - Calculations
      summary: Запуск нового расчёта
      operationId: runCalculation
      parameters:
        - $ref: '#/components/parameters/ProjectId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RunCalculationRequest'
      responses:
        '202':
          description: Расчёт поставлен в очередь.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunCalculationResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Уже есть активный расчёт для этого проекта.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          $ref: '#/components/responses/InternalError'

    get:
      tags:
        - Calculations
      summary: Список расчётов проекта
      operationId: listCalculations
      parameters:
        - $ref: '#/components/parameters/ProjectId'
      responses:
        '200':
          description: Список расчётов для указанного проекта.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CalculationSummary'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /projects/{projectId}/calculations/{calculationId}:
    get:
      tags:
        - Calculations
      summary: Детали расчёта
      operationId: getCalculation
      parameters:
        - $ref: '#/components/parameters/ProjectId'
        - $ref: '#/components/parameters/CalculationId'
      responses:
        '200':
          description: Детальная информация о расчёте.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CalculationDetails'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /projects/{projectId}/results:
    get:
      tags:
        - Results
      summary: Получение результатов расчёта
      description: >
        Возвращает результаты последнего успешного расчёта для проекта
        в структурированном виде (по узлам/сегментам).
      operationId: getResults
      parameters:
        - $ref: '#/components/parameters/ProjectId'
        - in: query
          name: calculationId
          schema:
            type: string
          description: Необязательно. Явно указать идентификатор расчёта.
      responses:
        '200':
          description: Результаты расчёта.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CalculationResultsResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /projects/{projectId}/export:
    post:
      tags:
        - Results
      summary: Экспорт результатов в файл
      operationId: exportResults
      parameters:
        - $ref: '#/components/parameters/ProjectId'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExportRequest'
      responses:
        '200':
          description: Файл с результатами.
          content:
            text/csv:
              schema:
                type: string
                format: binary
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /projects/{projectId}/subscribe:
    post:
      tags:
        - Notifications
      summary: Подписка на обновления по проекту
      description: Регистрирует WebSocket/endpoint для уведомлений о статусе расчёта.
      operationId: subscribe
      parameters:
        - $ref: '#/components/parameters/ProjectId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubscribeRequest'
      responses:
        '201':
          description: Подписка успешно оформлена.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscribeResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  parameters:
    ProjectId:
      in: path
      name: projectId
      required: true
      schema:
        type: string
      description: Идентификатор проекта.

    CalculationId:
      in: path
      name: calculationId
      required: true
      schema:
        type: string
      description: Идентификатор расчёта.

  responses:
    BadRequest:
      description: Некорректный запрос.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    NotFound:
      description: Ресурс не найден.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    Conflict:
      description: Конфликт состояния.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    InternalError:
      description: Внутренняя ошибка сервера.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  schemas:
    ProjectSummary:
      type: object
      required:
        - id
        - name
        - status
        - createdAt
      properties:
        id:
          type: string
          example: proj_123abc
        name:
          type: string
          example: Pipeline A
        status:
          type: string
          enum: [draft, ready, archived]
          description: Статус проекта
        lastCalculationStatus:
          type: string
          nullable: true
          enum: [queued, running, completed, failed]
          example: completed
        createdAt:
          type: string
          format: date-time
          example: '2026-01-14T00:00:00Z'

    ProjectDetails:
      allOf:
        - $ref: '#/components/schemas/ProjectSummary'
        - type: object
          properties:
            description:
              type: string
              nullable: true
              example: Основной трубопровод
            metadata:
              type: object
              additionalProperties: true

    CreateProjectRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
          example: Новый проект
        description:
          type: string
          nullable: true
          example: Описание проекта

    ImportOLGAResponse:
      type: object
      properties:
        project:
          $ref: '#/components/schemas/ProjectDetails'
        warnings:
          type: array
          items:
            type: string
          example:
            - 'Warning: Unknown element type detected'

    CalculationSummary:
      type: object
      required:
        - id
        - status
        - createdAt
      properties:
        id:
          type: string
          example: calc_456def
        status:
          type: string
          enum: [queued, running, completed, failed]
          description: Статус расчёта
        createdAt:
          type: string
          format: date-time
          example: '2026-01-14T10:30:00Z'
        finishedAt:
          type: string
          format: date-time
          nullable: true
          example: '2026-01-14T10:45:00Z'

    CalculationDetails:
      allOf:
        - $ref: '#/components/schemas/CalculationSummary'
        - type: object
          properties:
            parameters:
              type: object
              additionalProperties: true
              example:
                iterations: 100
                tolerance: 0.001
            errorMessage:
              type: string
              nullable: true
              example: null

    RunCalculationRequest:
      type: object
      properties:
        templateId:
          type: string
          nullable: true
          example: template_789
        parametersOverride:
          type: object
          additionalProperties: true
          example:
            iterations: 150
            tolerance: 0.0001

    RunCalculationResponse:
      type: object
      required:
        - calculationId
        - status
      properties:
        calculationId:
          type: string
          example: calc_789ghi
        status:
          type: string
          example: queued

    CalculationResultsResponse:
      type: object
      required:
        - projectId
        - calculationId
      properties:
        projectId:
          type: string
          example: proj_123abc
        calculationId:
          type: string
          example: calc_456def
        nodes:
          type: array
          items:
            $ref: '#/components/schemas/NodeResult'
        segments:
          type: array
          items:
            $ref: '#/components/schemas/SegmentResult'

    NodeResult:
      type: object
      required:
        - nodeId
        - pressure
        - temperature
        - flowRate
      properties:
        nodeId:
          type: string
          example: node_001
        pressure:
          type: number
          format: double
          example: 2.5
        temperature:
          type: number
          format: double
          example: 25.0
        flowRate:
          type: number
          format: double
          example: 100.5
        additional:
          type: object
          additionalProperties: true

    SegmentResult:
      type: object
      required:
        - segmentId
        - inletPressure
        - outletPressure
        - inletTemperature
        - outletTemperature
      properties:
        segmentId:
          type: string
          example: seg_001
        inletPressure:
          type: number
          format: double
          example: 3.0
        outletPressure:
          type: number
          format: double
          example: 2.5
        inletTemperature:
          type: number
          format: double
          example: 30.0
        outletTemperature:
          type: number
          format: double
          example: 28.5
        additional:
          type: object
          additionalProperties: true

    ExportRequest:
      type: object
      properties:
        format:
          type: string
          enum: [csv]
          default: csv
        includeHeaders:
          type: boolean
          default: true

    SubscribeRequest:
      type: object
      required:
        - channelType
        - target
      properties:
        channelType:
          type: string
          enum: [websocket, webhook]
          example: webhook
        target:
          type: string
          description: WebSocket path или URL webhook'а.
          example: https://api.example.com/v1
        events:
          type: array
          items:
            type: string
          description: Список типов событий
          example:
            - calculation.started
            - calculation.completed
            - calculation.failed

    SubscribeResponse:
      type: object
      required:
        - subscriptionId
        - createdAt
      properties:
        subscriptionId:
          type: string
          example: sub_999zzz
        createdAt:
          type: string
          format: date-time
          example: '2026-01-14T12:00:00Z'

    ErrorResponse:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          example: INVALID_REQUEST
        message:
          type: string
          example: Некорректные параметры запроса
        details:
          type: object
          additionalProperties: true
          example:
            field: name
            reason: 'Field is required'

