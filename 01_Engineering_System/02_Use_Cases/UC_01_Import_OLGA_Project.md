# UC01: Import OLGA Project

## 1. Краткое описание

Инженер импортирует существующий проект из OLGA в систему, чтобы получить структуру трубопроводной сети (узлы, трубы, профили) и далее использовать её для расчётов и визуализации.

---

## 2. Актёры

- **Primary Actor:** Engineer  
- **Supporting Actors:** External System (OLGA, как источник файлов)  

---

## 3. Предусловия

- У пользователя есть доступ к системе (авторизован).
- Пользователь имеет локальный доступ к файлам проекта OLGA (или к сетевой папке).
- Система настроена и доступен модуль импорта.

---

## 4. Постусловия

### При успешном завершении:

- В БД создан новый проект со статусом `draft` или `ready`.
- В БД сохранены сущности:
  - узлы (NODES),
  - трубопроводные сегменты (PIPES),
  - связанные параметры (через JSONB или отдельные таблицы — по реализации).
- В IMPORT_LOGS записана запись об импорте со статусом `completed`.
- Пользователь видит сообщение об успешном импорте и список предупреждений (если есть).

### При ошибке:

- В IMPORT_LOGS записана запись со статусом `failed` и текстом ошибки.
- Проект либо не создаётся, либо помечается как неконсистентный (зависит от политики).
- Пользователь видит сообщение об ошибке и её причину (в пределах, допустимых UI).

---

## 5. Триггер

- Пользователь выбирает команду «Импорт проекта OLGA» в UI.

---

## 6. Основной поток (Main Flow)

1. Пользователь в UI выбирает действие **«Импорт OLGA проекта»**.
2. Система отображает диалог выбора файлов и полей:
   - имя проекта,
   - необязательное описание,
   - выбор одного или нескольких файлов OLGA.
3. Пользователь выбирает файлы и указывает имя проекта.
4. Пользователь подтверждает импорт (нажимает кнопку «Импортировать»).
5. UI отправляет запрос `POST /projects/import/olga` в API с:
   - файлами OLGA,
   - именем проекта,
   - описанием (опционально).
6. API передаёт команду в Import Service.
7. Import Service:
   1. Создаёт запись в таблице PROJECTS (status = `draft`).
   2. Создаёт запись в IMPORT_LOGS (status = `started`).
8. Import Service передаёт файлы в OLGA Parser.
9. OLGA Parser валидирует структуру файлов и версию формата.
10. При успехе парсинга Parser возвращает в Import Service:
    - список узлов,
    - список труб,
    - дополнительные параметры (в зависимости от домена).
11. Import Service сохраняет данные в БД:
    - вставляет записи в NODES,
    - вставляет записи в PIPES,
    - при необходимости — дополнительные сущности/параметры.
12. Import Service обновляет IMPORT_LOGS:
    - status = `completed`,
    - при необходимости — сообщение с количеством импортированных объектов и предупреждениями.
13. Import Service возвращает в API результат с:
    - идентификатором созданного проекта,
    - списком предупреждений (warnings), если были.
14. API возвращает UI ответ `201 Created` с:
    - projectId,
    - именем проекта,
    - статусом импорта,
    - списком предупреждений.
15. UI показывает пользователю:
    - уведомление об успешном импорте,
    - кнопку «Открыть проект»,
    - список предупреждений (например, игнорированные объекты, устаревшие параметры).

---

## 7. Альтернативные потоки

### A1: Пользователь отменяет выбор файлов

- На шаге 2 пользователь закрывает диалог без выбора файлов.
- Система отменяет операцию, никаких запросов на сервер не отправляется.
- Отображается исходный экран без изменений.

### A2: Пользователь выбрал некорректный набор файлов

Условие: на шаге 5 переданы файлы, которые не соответствуют ожидаемому формату OLGA (не хватает части файлов, неверное расширение и т.п.).

1. Import Service при обращении к Parser получает ошибку валидации.
2. Import Service записывает в IMPORT_LOGS:
   - status = `failed`,
   - message = причина (например, «Отсутствует файл .key»).
3. Import Service возвращает в API ответ с ошибкой валидации.
4. API возвращает в UI статус **422 Unprocessable Entity** с описанием ошибки.
5. UI показывает пользователю:
   - текст ошибки,
   - подсказки по корректному набору файлов.

### A3: Ошибка сохранения в БД

Условие: на шаге 11 при сохранении данных происходит ошибка (например, нарушение constraint’а).

1. Import Service фиксирует ошибку, отменяет транзакцию (если используется).
2. В IMPORT_LOGS создаётся запись со статусом `failed` и описанием ошибки.
3. Import Service возвращает в API техническую ошибку.
4. API возвращает в UI статус **500 Internal Server Error** с общим описанием.
5. UI показывает пользователю сообщение:
   - «При выполнении импорта произошла техническая ошибка. Попробуйте позже или обратитесь к поддержке.»

---

## 8. Исключения (Exception Flows)

### E1: Обрыв соединения при загрузке файлов

- Если соединение оборвалось до отправки запроса на сервер — импорт не начат, пользователь может повторить попытку.
- Если обрыв произошёл после начала импорта, но до ответа:
  - статус импорта можно проверить через список проектов или отдельный экран логов.

### E2: Лимит размера файлов

- При превышении лимита (на уровне API или веб‑сервера) запрос отклоняется с 413 Payload Too Large (или аналогичным кодом).
- Пользователь видит сообщение о превышении размера и рекомендации (например, разбить проект).

---

## 9. Бизнес‑правила

- Имя проекта должно быть уникальным в рамках системы или выбранной области (в зависимости от бизнес‑политики).
- При повторном импорте того же проекта:
  - либо создаётся новый проект,
  - либо выполняется обновление существующего — решается отдельной политикой (в данном UC предполагается создание нового).

---

## 10. Нефункциональные требования (контекст UC)

- Время импорта типового проекта не должно превышать N минут (зависит от размера).
- Все ошибки импорта должны логироваться с достаточным контекстом (IMPORT_LOGS, ERROR_LOGS).
- Пользователь должен получать понятные сообщения об ошибках, без утечки технических деталей.

---
