# UC02: Run Calculation

## 1. Краткое описание

Инженер запускает расчёт для выбранного проекта, используя сохранённый шаблон или задавая параметры вручную. Система формирует задание, передаёт его в расчётный модуль и сохраняет результаты.

---

## 2. Актёры

- **Primary Actor:** Engineer  
- **Supporting Actors:**  
  - Calculation Service (Python)  
  - Calculation Engine (C++ ядро)  

---

## 3. Предусловия

- Проект существует в системе и находится в состоянии, позволяющем расчёт (например, `ready`).
- Топология (узлы, трубы) успешно импортирована или создана.
- Для проекта есть хотя бы один валидный набор параметров:
  - либо шаблон,
  - либо пользователь может задать параметры вручную.
- Пользователь авторизован и имеет доступ к проекту.

---

## 4. Постусловия

### При успешном завершении:

- В таблице CALCULATIONS создана запись:
  - status = `completed`,
  - заполнены timestamps `started_at` и `finished_at`,
  - сохранены использованные параметры.
- В таблице CALCULATION_RESULTS сохранены результаты по узлам/сегментам.
- Пользователь может открыть и просмотреть результаты расчёта.
- При необходимости отправлено уведомление (WebSocket/уведомление в UI).

### При ошибке:

- В CALCULATIONS статус = `failed`, заполнено поле `error_message`.
- В ERROR_LOGS есть запись с контекстом ошибки.
- Пользователю отображено сообщение об ошибке.

---

## 5. Триггер

- Пользователь нажимает кнопку **«Запустить расчёт»** на экране проекта/параметров.

---

## 6. Основной поток (Main Flow)

1. Пользователь открывает экран проекта и выбирает расчетный сценарий:
   - существующий шаблон,
   - или режим ручного ввода параметров.
2. Система отображает форму параметров:
   - дебиты,
   - давления на входе/выходе,
   - температурные режимы,
   - дополнительные настройки (шаг по длине, критерии сходимости и т.п.).
3. Пользователь задаёт/корректирует значения параметров.
4. Пользователь нажимает кнопку **«Запустить расчёт»**.
5. UI отправляет запрос `POST /projects/{projectId}/calculations`:
   - `templateId` (если выбран шаблон),
   - `parametersOverride` (если есть изменения относительно шаблона).
6. API:
   1. Валидирует входные данные.
   2. Создаёт запись в CALCULATIONS:
      - status = `queued`,
      - сохраняет входные параметры (JSONB),
      - при необходимости — ссылку на шаблон.
7. API ставит задачу в очередь/передаёт команду Calculation Service (`calculationId`, `projectId`).
8. API возвращает UI ответ `202 Accepted` с:
   - `calculationId`,
   - текущим статусом (`queued`).
9. UI отображает пользователю состояние расчёта:
   - индикатор «В очереди/Выполняется»,
   - ссылку/кнопку для просмотра статуса.
10. Calculation Service извлекает задание из очереди.
11. Calculation Service загружает из БД:
    - данные проекта (топологию),
    - параметры расчёта (по шаблону + overrides).
12. Calculation Service формирует входной набор для Calculation Engine (C++).
13. Calculation Service вызывает Calculation Engine с подготовленными данными.
14. Calculation Engine выполняет численный расчёт и возвращает:
    - набор результатов по узлам/сегментам,
    - потенциальные предупреждения (convergence, extrapolation и т.п.).
15. Calculation Service:
    - создает записи в CALCULATION_RESULTS для каждого узла/сегмента,
    - обновляет запись CALCULATIONS:
      - status = `completed`,
      - `finished_at = now()`,
      - при необходимости — сохраняет предупреждения в дополнительном поле/JSON.
16. Calculation Service публикует событие о завершении расчёта (через Notification Service).
17. UI (или WebSocket‑клиент) получает уведомление и обновляет статус на экране:
    - «Расчёт завершен успешно».
18. Пользователь может перейти к сценарию **UC03: View Results**.

---

## 7. Альтернативные потоки

### A1: Запуск без шаблона (чистый ручной ввод)

Условие: пользователь не использует шаблон, все параметры вводятся вручную.

- На шаге 2 система отображает пустую форму параметров либо форму с дефолтами.
- На шаге 5 UI отправляет запрос без `templateId`, только `parametersOverride`.
- Дальнейшие шаги идентичны основному потоку, параметры берутся только из JSON переопределений.

### A2: Использование шаблона по умолчанию

Условие: для проекта помечен шаблон `is_default = true`.

- На шаге 1 система может автоматически подставить default шаблон.
- Пользователь может:
  - сразу нажать «Запустить расчёт»,
  - или внести минимальные изменения.
- На шаге 5 вместе с `templateId` передаются только изменённые параметры.

### A3: Параллельные расчёты запрещены

Условие: политика системы не допускает несколько активных расчётов для одного проекта.

- На шаге 6.2 API проверяет наличие расчётов со статусами `queued` или `running` для данного проекта.
- Если такие есть:
  - API возвращает код `409 Conflict` с сообщением «Расчёт уже выполняется».
  - Система предлагает ждать завершения текущего расчёта или отменить его (если предусмотрено).

---

## 8. Исключения (Exception Flows)

### E1: Ошибка на стороне Calculation Engine

- Calculation Engine возвращает ошибку (например, несходимость, некорректные данные).
- Calculation Service:
  - записывает информацию об ошибке в ERROR_LOGS (с контекстом),
  - обновляет CALCULATIONS:
    - status = `failed`,
    - заполняет `error_message`.
- User Interface через Notification Service или при опросе статуса получает информацию о неуспешном завершении.
- Пользователь видит сообщение:
  - «Расчёт завершился с ошибкой: …»
  - может перейти к редактированию параметров (UC05).

### E2: Ошибка чтения данных проекта

- На шаге 11 при чтении БД возникает ошибка (отсутствуют необходимые данные, нарушение целостности).
- Calculation Service:
  - логирует ошибку в ERROR_LOGS,
  - помечает расчёт как `failed`.
- UI показывает пользователю сообщение о технической ошибке и предлагает обратиться к поддержке.

### E3: Таймаут или обрыв связи с движком

- Calculation Service не получает ответа от Calculation Engine в течение заданного таймаута.
- В зависимости от политики:
  - либо расчёт помечается как `failed` с error_message = `timeout`,
  - либо статус остаётся `running` и происходит повторный опрос до тех пор, пока не будет принято решение.
- Пользователь видит актуальный статус на экране статуса расчёта.

---

## 9. Бизнес‑правила

- Нельзя запускать расчёт для проекта, у которого:
  - отсутствуют узлы/трубы,
  - нарушена целостность топологии.
- Ограничения по параметрам (диапазоны давлений, температур и т.п.) должны валидироваться до запуска.
- Политика допуска / запрета параллельных расчётов настраивается (по умолчанию — 1 активный расчёт на проект).

---

## 10. Нефункциональные требования (контекст UC)

- Время постановки расчёта в очередь (API‑ответ 202) должно быть ≤ 1–2 секунд.
- Время самого расчёта зависит от модели, но система должна:
  - корректно обрабатывать долгие расчёты,
  - не блокировать UI.
- Все ошибки и важные события логируются (CALCULATIONS, ERROR_LOGS).
- Статус расчёта должен быть доступен через API и/или push‑уведомления.

---
