# Architecture Overview — Engineering Calculation System

Высокоуровневая архитектура системы расчёта и визуализации параметров трубопровода.

---

## 1. Цели архитектуры

Архитектура системы спроектирована для того, чтобы:

- поддерживать полный цикл работы инженера: импорт модели → настройка параметров → расчёт → анализ результатов → экспорт;
- разделять ответственность между слоями (UI, API, бизнес‑логика, расчётное ядро, данные);
- упростить интеграцию с существующим расчётным ядром на C++ и внешними инструментами;
- обеспечить масштабируемость и поддерживаемость системы.

---

## 2. Высокоуровневая схема

Система логически разделена на следующие слои:

1. **Client Layer (UI)**  
   - Desktop UI (Qt‑приложение / thick client).  
   - Web UI (SPA — браузерный интерфейс).  

2. **API Layer**  
   - REST API (Python / FastAPI или аналог).  

3. **Application Layer**  
   - Import Service (обработка файлов OLGA, создание проекта).  
   - Calculation Service (оркестрация расчётов).  
   - Export Service (формирование CSV/экспортных файлов).  
   - Notification Service (подписки и уведомления).  

4. **Domain / Engine Layer**  
   - Calculation Engine (C++ библиотека/движок).  
   - OLGA Parser (модуль парсинга входных файлов).  

5. **Data Layer**  
   - PostgreSQL (реляционная база данных).  

Взаимодействие слоёв:

- UI → API по HTTPS (JSON/REST).
- API → сервисы приложения по внутренним вызовам/очередям.
- Сервисы приложения → Calculation Engine/Parser по нативному интерфейсу или IPC.
- Все устойчивые данные хранятся в PostgreSQL (проекты, топология, расчёты, результаты, логи).

---

## 3. Поток данных (сквозной сценарий)

### 3.1. Импорт проекта

1. Инженер в UI выбирает «Импорт проекта OLGA».
2. UI отправляет файлы и метаданные в API.
3. API передаёт команду Import Service.
4. Import Service:
   - создаёт запись проекта,
   - вызывает OLGA Parser,
   - сохраняет топологию и параметры в БД,
   - пишет лог импорта.
5. API возвращает результат импорта в UI.

### 3.2. Запуск расчёта

1. Инженер настраивает параметры/выбирает шаблон и нажимает «Запустить расчёт».
2. UI вызывает API (POST `/projects/{id}/calculations`).
3. API создаёт запись в CALCULATIONS и отправляет задание Calculation Service.
4. Calculation Service:
   - загружает данные проекта и параметры из БД,
   - формирует входной набор,
   - вызывает Calculation Engine (C++),
   - сохраняет результаты в CALCULATION_RESULTS,
   - обновляет статус расчёта.
5. Notification Service уведомляет UI о завершении расчёта.

### 3.3. Просмотр и экспорт результатов

1. UI запрашивает результаты через API (`GET /projects/{id}/results`).
2. API читает результаты из БД и возвращает структурированные данные.
3. Для экспорта UI вызывает `POST /projects/{id}/export`, Export Service формирует CSV и отдаёт файл.

---

## 4. Граничные контексты

Условно выделены следующие контексты:

- **Project Management Context**  
  Управление проектами, импортами, правами доступа, метаданными.

- **Calculation Context**  
  Постановка задач расчёта, запуск, отслеживание статусов, работа с Calculation Engine.

- **Results & Reporting Context**  
  Хранение и предоставление результатов, визуализация, экспорт.

- **Integration Context**  
  Взаимодействие с OLGA и другими внешними системами, парсеры, конвертеры.

Каждый контекст имеет свои сущности и границы ответственности; пересечения происходят через API и общую БД.

---

## 5. Основные архитектурные решения

- **Слои и сервисы.**  
  Архитектура многослойная, с выделением отдельных сервисов для импорта, расчёта и экспорта, что упрощает масштабирование и развитие.

- **Стабильное ядро.**  
  Calculation Engine реализован на C++ и рассматривается как «чёрный ящик» с чётко определённым интерфейсом. Остальная система адаптируется вокруг него.

- **Реляционная БД + JSONB.**  
  Статические сущности (проекты, узлы, трубы, результаты) описаны в нормализованной схеме; для гибких параметров используется JSONB.

- **REST API как единая точка доступа.**  
  Все клиентские приложения и интеграции работают через REST API, описанный в OpenAPI‑спецификации.

- **Асинхронная обработка долгих операций.**  
  Импорт и расчёты могут выполняться асинхронно; пользователю возвращается быстрый ответ и возможность отслеживать статус.

---

## 6. Наблюдаемость и логирование

- Логи импортов (IMPORT_LOGS) и ошибок (ERROR_LOGS) позволяют проследить жизненный цикл импорта и расчёта.
- Метрики (количество расчётов, время выполнения) могут собираться на уровне сервисов.
- Структура логов и метрик ориентирована на интеграцию с корпоративными системами мониторинга.

---

## 7. Эволюция и расширяемость

Архитектура позволяет:

- добавлять новые источники данных (кроме OLGA) путём добавления новых модулей парсинга;
- расширять набор типов расчётов, оставляя Calculation Engine изолированным компонентом;
- внедрять новые UI‑клиенты (например, мобильный) без изменений ядра — через REST API;
- масштабировать отдельные сервисы (например, Calculation Service) независимо от UI и БД.

---
